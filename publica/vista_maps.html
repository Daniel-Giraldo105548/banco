<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cajeros - Banco</title>

    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        text-align: center;
      }

      h2 {
        margin: 10px 0;
        color: #2c3e50;
      }

      #map {
        height: 90vh;
        width: 100%;
        border-top: 3px solid #3498db;
      }
    </style>
  </head>

  <body>
    <h2>üè¶ Cajeros del Banco</h2>
    <div id="map"></div>

    <script>
      let map;

      // Inicializa el mapa
      function initMap() {
        // Centrar provisionalmente en Bogot√°
        map = new google.maps.Map(document.getElementById("map"), {
          center: { lat: 4.711, lng: -74.0721 },
          zoom: 12,
        });

        // Mostrar los corresponsales del banco
        mostrarCorresponsales();
      }

      // Funci√≥n para obtener y mostrar corresponsales del backend
      async function mostrarCorresponsales() {
        try {
          const res = await fetch("http://localhost:3000/api/corresponsal/listar");
          const data = await res.json();
          const corresponsales = data.resultado;

          // Si hay corresponsales, ajustar el centro del mapa
          const bounds = new google.maps.LatLngBounds();

          corresponsales.forEach((c) => {
            const lat = parseFloat(c.latitud);
            const lng = parseFloat(c.longitud);

            // Validar que existan coordenadas v√°lidas
            if (!isNaN(lat) && !isNaN(lng)) {
              const marker = new google.maps.Marker({
                position: { lat, lng },
                map,
                title: c.tipo,
                icon: "http://maps.google.com/mapfiles/ms/icons/red-dot.png",
              });

              // Ventana de informaci√≥n al hacer clic
              const info = new google.maps.InfoWindow({
                content: `
                  <div style="font-size:14px; text-align:left;">
                    <b>${c.tipo}</b><br>
                    üìç <b>Direcci√≥n:</b> ${c.direccion || "No registrada"}<br>
                    üèòÔ∏è <b>Barrio:</b> ${c.Barrio?.nombre || "Desconocido"}
                  </div>
                `,
              });

              marker.addListener("click", () => info.open(map, marker));

              // Agregar el punto al √°rea visible
              bounds.extend({ lat, lng });
            }
          });

          // Centrar el mapa en los puntos encontrados
          if (corresponsales.length > 0) {
            map.fitBounds(bounds);
          }
        } catch (err) {
          console.error("Error cargando corresponsales:", err);
        }
      }
    </script>

    <!-- Cargar la API de Google Maps -->
    <script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCMZ7B5m9CNUUQ9SE_hocvvLduTRCccmy8&callback=initMap&loading=async"
      async
      defer>
    </script>
  </body>
</html>
